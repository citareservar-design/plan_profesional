{% extends "admin/layout.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="p-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
        <div>
            <h1 class="text-4xl font-black text-white tracking-tighter uppercase italic">
                Team <span class="text-sky-500 italic">Control</span>
            </h1>
            <p class="text-slate-400 font-bold uppercase text-[10px] tracking-[0.3em] mt-2 flex items-center gap-2">
                <span class="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></span>
                Acceso y seguridad del sistema
            </p>
        </div>
        <button onclick="abrirModalNuevo()" 
                class="bg-white hover:bg-sky-500 text-black hover:text-white px-8 py-4 rounded-[2rem] font-black uppercase text-xs tracking-widest transition-all duration-300 shadow-2xl shadow-white/5 active:scale-95 flex items-center gap-3">
            <i class="fa-solid fa-user-plus"></i> Nuevo Usuario
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for usuario in usuarios %}
        <div class="group relative bg-slate-900/40 backdrop-blur-md border border-white/5 rounded-[2.5rem] p-8 transition-all duration-500 hover:bg-slate-900/60 hover:border-sky-500/30 hover:-translate-y-2">
            
            <div class="absolute top-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <button onclick="editarUsuario('{{ usuario.usu_id }}')" 
                        class="w-10 h-10 rounded-full bg-white/5 text-slate-400 hover:bg-sky-500 hover:text-white transition-all flex items-center justify-center">
                    <i class="fa-solid fa-pen-to-square text-xs"></i>
                </button>
                <button onclick="confirmarEliminar('{{ usuario.usu_id }}', '{{ usuario.usu_login }}')"
                        class="w-10 h-10 rounded-full bg-white/5 text-slate-400 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center">
                    <i class="fa-solid fa-trash text-xs"></i>
                </button>
            </div>

            <div class="flex flex-col items-center text-center mb-6">
                <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-sky-500/20 to-indigo-600/20 border border-sky-500/30 flex items-center justify-center text-sky-400 text-3xl font-black mb-4 group-hover:scale-110 transition-transform duration-500 shadow-inner">
                    {{ usuario.usu_login[0] | upper }}
                </div>
                <h3 class="text-xl font-black text-white tracking-tight uppercase">{{ usuario.usu_login }}</h3>
                <span class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">{{ usuario.usu_nombre }}</span>
                
                <div class="mt-4">
                    {% if usuario.usu_rol == 'admin' %}
                    <span class="bg-amber-500/10 text-amber-500 text-[9px] px-4 py-1.5 rounded-full font-black uppercase border border-amber-500/20 tracking-widest">Super Admin</span>
                    {% else %}
                    <span class="bg-slate-800 text-slate-400 text-[9px] px-4 py-1.5 rounded-full font-black uppercase tracking-widest">Staff Member</span>
                    {% endif %}
                </div>
            </div>

            <div class="pt-6 border-t border-white/5">
                <p class="text-[9px] text-slate-500 font-black uppercase tracking-[0.2em] mb-4 text-center">Módulos Activos</p>
<div class="flex flex-wrap justify-center gap-1.5 px-4">
    {# CAMBIO CLAVE: 'usuario.PERMISOS' en lugar de 'usuario.permisos' #}
    {% for permiso in usuario.PERMISOS %}
    <span class="bg-sky-500/10 text-sky-400 text-[8px] px-2 py-1 rounded-md font-black uppercase border border-sky-500/20 group-hover:bg-sky-500 group-hover:text-white transition-all duration-300">
        {# CAMBIO CLAVE: 'perm_nombre' en lugar de 'perm_nombre' o 'per_nombre' #}
        {{ permiso.perm_nombre | replace('ver_', '') | upper }}
    </span>
    {% else %}
    <span class="text-slate-600 text-[9px] font-bold uppercase italic tracking-tighter">Sin accesos</span>
    {% endfor %}
</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</div>

<div id="modalUsuario" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl">
        <h2 id="modalTitulo" class="text-2xl font-black text-white mb-6">Nuevo <span class="text-sky-500">Usuario</span></h2>
        
        <form id="formUsuario" action="{{ url_for('admin.crear_usuario') }}" method="POST" class="space-y-4">
            <input type="text" id="usu_login" name="usu_login" placeholder="Nombre de usuario (Login)" required 
                   class="w-full bg-slate-800 border-none rounded-2xl p-4 text-white font-bold outline-none focus:ring-2 focus:ring-sky-500">
            
            <input type="text" id="usu_nombre" name="usu_nombre" placeholder="Nombre Completo" required 
                   class="w-full bg-slate-800 border-none rounded-2xl p-4 text-white font-bold outline-none focus:ring-2 focus:ring-sky-500">
            
            <input type="password" id="usu_password" name="usu_password" placeholder="Contraseña" required 
                   class="w-full bg-slate-800 border-none rounded-2xl p-4 text-white font-bold outline-none focus:ring-2 focus:ring-sky-500">
            
            <div class="py-4">
                <p class="text-slate-400 font-black text-[10px] uppercase tracking-widest mb-4">Asignar Permisos de Acceso</p>

                
                {% set modulos = ['estadisticas', 'clientes', 'empleados', 'servicios', 'reservas', 'horarios', 'usuarios', 'empresa', 'QR', 'comisiones', 'historial'] %}

                <div class="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                    {% for mod in modulos %}
                    <label class="flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5 cursor-pointer hover:border-sky-500/50 transition-all">
                        <input type="checkbox" name="permisos" value="ver_{{ mod }}" 
                               class="permiso-checkbox w-4 h-4 rounded border-none bg-slate-700 text-sky-500 focus:ring-sky-500">
                        
                        {# Si es historial, le damos un toque verde para que resalte #}
                        <span class="text-white text-xs font-bold capitalize {% if mod == 'historial' %} text-emerald-400 {% endif %}">
                            {{ mod | replace('_', ' ') }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="button" onclick="document.getElementById('modalUsuario').classList.add('hidden')" 
                        class="flex-1 bg-white/5 text-white py-4 rounded-2xl font-bold hover:bg-white/10 transition-all">Cancelar</button>
                <button type="submit" id="btnGuardar" class="flex-1 bg-sky-500 text-white py-4 rounded-2xl font-bold hover:bg-sky-400 transition-all shadow-lg shadow-sky-500/20">Crear Usuario</button>
            </div>
        </form>
    </div>
</div>
<script src="{{ url_for('static', filename='js/usuarios.js') }}"></script>
{% endblock %}