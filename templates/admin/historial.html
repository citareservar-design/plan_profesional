{% extends "admin/layout.html" %}

{% block content %}
<script>
    window.reservasData = {{ reservas_json | safe if reservas_json else '[]' }};
</script>

<div class="space-y-6" 
     x-data="{ 
        search: '', 
        status: '', 
        date: '', 
        empSearch: '', 
        items: window.reservasData 
     }">

    <div class="bg-slate-900/50 border border-white/5 rounded-[2.5rem] p-6 backdrop-blur-md shadow-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">

            <form method="GET" action="{{ url_for('admin.gestion_historial') }}" class="space-y-2">
        <label class="text-[10px] uppercase tracking-[0.2em] font-black text-slate-500 ml-2">Buscador</label>
        <div class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
            <input type="text" 
                   name="busqueda" 
                   value="{{ busqueda_actual }}"
                   placeholder="Enter para buscar..." 
                   class="w-full bg-slate-800/40 border border-white/5 rounded-2xl py-3 pl-10 pr-4 text-white text-sm font-bold focus:ring-2 focus:ring-sky-500 outline-none transition-all">
        </div>
    </form>

            <div class="space-y-2">
                <label class="text-[10px] uppercase tracking-[0.2em] font-black text-slate-500 ml-2">Empleado</label>
                <select x-model="empSearch" class="w-full bg-slate-800/40 border border-white/5 rounded-2xl py-3 px-4 text-white text-sm font-bold outline-none appearance-none cursor-pointer">
                    <option value="">Todos</option>
                    <template x-for="emp in [...new Set(items.map(i => i.empleado))].filter(Boolean)" :key="emp">
                        <option :value="emp" x-text="emp"></option>
                    </template>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] uppercase tracking-[0.2em] font-black text-slate-500 ml-2">Estado</label>
                <select x-model="status" class="w-full bg-slate-800/40 border border-white/5 rounded-2xl py-3 px-4 text-white text-sm font-bold outline-none appearance-none">
                    <option value="">Todos</option>
                    <option value="realizada">✨ Realizada</option>
                    <option value="pendiente">⏳ Pendiente</option>
                    <option value="confirmada">✅ Confirmada</option>
                    <option value="cancelada">❌ Cancelada</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] uppercase tracking-[0.2em] font-black text-slate-500 ml-2">Fecha</label>
                <input type="date" x-model="date" class="w-full bg-slate-800/40 border border-white/5 rounded-2xl py-3 px-4 text-white text-sm font-bold [color-scheme:dark]">
            </div>

            <div class="flex items-end h-[52px]">
<a href="{{ url_for('admin.gestion_historial') }}" 
   x-show="search || status || date || empSearch || '{{ busqueda_actual }}'"
   class="w-full h-full bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 border border-rose-500/20 rounded-2xl font-black text-[10px] uppercase flex items-center justify-center transition-all">
    LIMPIAR
</a>
            </div>

            <div class="flex items-end h-[52px]">
                <div class="w-full bg-sky-500/10 rounded-2xl border border-sky-500/20 flex flex-col justify-center items-center h-full">
                    <span class="text-slate-500 text-[8px] uppercase font-black">Citas</span>
                    <span class="text-sky-500 font-black text-sm" x-text="items.filter(i => {
                        const s = search.toLowerCase();
                        const st = status.toLowerCase();
                        return (!search || (i.cliente && i.cliente.toLowerCase().includes(s)) || (i.servicio && i.servicio.toLowerCase().includes(s)))
                        && (!status || (i.estado && i.estado.toLowerCase() === st))
                        && (!date || i.fecha_iso === date)
                        && (!empSearch || i.empleado === empSearch);
                    }).length">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-slate-900/50 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl backdrop-blur-sm">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-white/5 border-b border-white/5">
                    <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400">Cliente</th>
                    <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400">Servicio</th>
                    <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400">Cita</th> <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400">Estado</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
<template x-for="item in items.filter(i => {
    const s = search.toLowerCase();
    const st = status.toLowerCase();
    
    // Filtros lógicos
    const matchSearch = !search || (i.cliente && i.cliente.toLowerCase().includes(s)) || (i.servicio && i.servicio.toLowerCase().includes(s));
    const matchStatus = !status || (i.estado && i.estado.toLowerCase() === st);
    const matchEmp = !empSearch || i.empleado === empSearch;
    
    // FILTRO DE FECHA (Aquí está el truco)
    // El input date de HTML devuelve 'YYYY-MM-DD'. Comparamos contra i.fecha_iso
    const matchDate = !date || i.fecha_iso === date;

    return matchSearch && matchStatus && matchEmp && matchDate;
})" :key="item.id">
                    <tr class="hover:bg-white/[0.03] transition-all">
                        <td class="px-8 py-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-sky-500/10 flex items-center justify-center text-sky-500 font-black" x-text="(item.cliente || '?')[0].toUpperCase()"></div>
                                <p class="text-white font-bold" x-text="item.cliente"></p>
                            </div>
                        </td>
                        <td class="px-8 py-6">
                            <p class="text-slate-200 font-black text-sm" x-text="item.servicio"></p>
                            <p class="text-[10px] text-sky-400/80 font-bold uppercase" x-text="item.empleado"></p>
                        </td>
<td class="px-8 py-6">
    <div class="flex flex-col">
        <span class="text-white font-bold text-sm" x-text="item.fecha_display"></span>
        <span class="text-sky-500 font-black text-[10px]" x-text="item.hora"></span>
    </div>
</td>
                        <td class="px-8 py-6">
                            <span :class="{
                                'bg-emerald-500/10 text-emerald-400': item.estado && item.estado.toLowerCase() === 'realizada',
                                'bg-rose-500/10 text-rose-400': item.estado && item.estado.toLowerCase() === 'cancelada',
                                'bg-amber-500/10 text-amber-400': item.estado && item.estado.toLowerCase() === 'pendiente',
                                'bg-sky-500/10 text-sky-400': item.estado && item.estado.toLowerCase() === 'confirmada'
                            }" class="px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-wider" x-text="item.estado"></span>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
</div>
</div>
{% endblock %}