{% extends "admin/layout.html" %}
{% block content %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>
    [x-cloak] { display: none !important; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
</style>

<div x-data="{ 
    openModal: false, 
    items: [], 
    filtrosActivos: {{ 'true' if request.args else 'false' }},
    init() {
        // Buscamos los datos que Flask dejó en el script de abajo
        const dataElement = document.getElementById('reservas-data');
        if (dataElement) {
            this.items = JSON.parse(dataElement.textContent);
        }
    }
}" class="space-y-6">

    <div class="bg-slate-900/50 border border-white/5 rounded-[2.5rem] p-6 backdrop-blur-md flex flex-col md:flex-row justify-between items-center gap-4 shadow-2xl">
        <div>
            <h1 class="text-white font-black text-2xl ml-4">Historial de Reservas</h1>
            <p class="text-slate-500 text-xs ml-4 uppercase tracking-[0.3em] font-bold">Base de datos centralizada</p>
        </div>
        
        <div class="flex gap-3">
            <template x-if="filtrosActivos">
                <a href="{{ url_for('admin.gestion_historial') }}" class="px-6 py-3 bg-rose-500/10 text-rose-500 rounded-2xl border border-rose-500/20 text-[10px] font-black uppercase tracking-widest hover:bg-rose-500/20 transition-all flex items-center">
                    <i class="fa-solid fa-trash-can mr-2"></i> Limpiar Filtros
                </a>
            </template>
<button @click="openModal = true; console.log('Abriendo modal...')" 
        class="px-8 py-3 bg-sky-500 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-sky-500/20 hover:scale-105 active:scale-95 transition-all flex items-center gap-2">
    <i class="fa-solid fa-sliders"></i> Filtrar Agenda
</button>
        </div>
    </div>

<div id="modal-historial"
    x-show="openModal" 
    x-cloak
    class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md"
    style="display: none;"
>
        <div @click.away="openModal = false" 
             class="bg-slate-900 border border-white/10 w-full max-w-2xl rounded-[3rem] p-8 shadow-2xl relative overflow-hidden">
            
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-white font-black text-xl uppercase tracking-tighter">Filtros de búsqueda</h2>
                    <p class="text-slate-500 text-[10px] uppercase font-bold tracking-widest">Ajusta los parámetros de consulta</p>
                </div>
                <button @click="openModal = false" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

<form method="GET" action="{{ url_for('admin.gestion_historial') }}" class="space-y-6">
    
    <div class="space-y-2">
        <label class="text-[10px] font-black text-slate-500 uppercase ml-2 tracking-widest">Nombre del Cliente</label>
        <input type="text" name="busqueda" value="{{ request.args.get('busqueda', '') }}" placeholder="Ej: Juan Perez..." class="w-full bg-slate-800/50 border border-white/5 rounded-2xl py-4 px-6 text-white font-bold focus:ring-2 focus:ring-sky-500 outline-none transition-all">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
            <label class="text-[10px] font-black text-slate-500 uppercase ml-2 tracking-widest">Rango de tiempo</label>
            <div class="flex flex-col gap-2">
                <input type="date" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}" class="bg-slate-800/50 border border-white/5 rounded-2xl py-3 px-4 text-white font-bold [color-scheme:dark]">
                <input type="date" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}" class="bg-slate-800/50 border border-white/5 rounded-2xl py-3 px-4 text-white font-bold [color-scheme:dark]">
            </div>
        </div>

        <div class="space-y-2">
            <label class="text-[10px] font-black text-slate-500 uppercase ml-2 tracking-widest">Estados</label>
            <div class="bg-slate-800/50 border border-white/5 rounded-3xl p-4 grid grid-cols-2 gap-2">
                {% for st in ['Pendiente', 'Confirmada', 'Realizada', 'Completada', 'Cancelada'] %}
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" name="estados" value="{{ st }}" class="rounded border-white/10 bg-slate-700 text-sky-500 focus:ring-sky-500" {{ 'checked' if st in request.args.getlist('estados') }}>
                    <span class="text-slate-400 text-[10px] font-black uppercase group-hover:text-white transition-colors">{{ st }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="space-y-2">
        <label class="text-[10px] font-black text-slate-500 uppercase ml-2 tracking-widest">Servicios</label>
        <div class="bg-slate-800/50 border border-white/5 rounded-3xl p-4 max-h-40 overflow-y-auto custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-2">
            {% for ser in servicios %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 rounded-xl hover:bg-white/5 transition-all">
                <input type="checkbox" name="servicios" value="{{ ser.ser_id }}" class="rounded border-white/10 bg-slate-700 text-sky-500 focus:ring-sky-500" {{ 'checked' if ser.ser_id|string in request.args.getlist('servicios') }}>
                <span class="text-slate-200 text-[10px] font-black uppercase">{{ ser.ser_nombre }}</span>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="space-y-2">
        <label class="text-[10px] font-black text-slate-500 uppercase ml-2 tracking-widest">Profesionales</label>
        <div class="bg-slate-800/50 border border-white/5 rounded-3xl p-4 max-h-40 overflow-y-auto custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-2">
            {% for emp in empleados %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 rounded-xl hover:bg-white/5 transition-all">
                <input type="checkbox" name="empleados" value="{{ emp.empl_id }}" class="rounded border-white/10 bg-slate-700 text-sky-500 focus:ring-sky-500" {{ 'checked' if emp.empl_id|string in request.args.getlist('empleados') }}>
                <span class="text-slate-200 text-[10px] font-black uppercase">{{ emp.empl_nombre }}</span>
            </label>
            {% endfor %}
        </div>
    </div>

    <button type="submit" class="w-full py-5 bg-sky-500 text-white rounded-3xl font-black uppercase tracking-[0.2em] transition-all shadow-xl shadow-sky-500/20 flex items-center justify-center gap-3 hover:bg-sky-400">
        <i class="fa-solid fa-magnifying-glass"></i> Procesar Consulta
    </button>
</form>
        </div>
    </div>

    <div class="bg-slate-900/50 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl backdrop-blur-sm">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white/5 border-b border-white/5">
                        <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400 tracking-widest">Cliente</th>
                        <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400 tracking-widest">Servicio / Profesional</th>
                        <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400 tracking-widest">Cita Agendada</th>
                        <th class="px-8 py-6 text-[10px] uppercase font-black text-slate-400 text-center tracking-widest">Estado</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    <template x-for="item in items" :key="item.id">
                        <tr class="hover:bg-white/[0.03] transition-all group">
                            <td class="px-8 py-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-sky-500/20 to-sky-500/5 flex items-center justify-center text-sky-500 font-black border border-white/5 group-hover:border-sky-500/30 transition-all shadow-inner" x-text="item.cliente[0]"></div>
                                    <p class="text-white font-black tracking-tight" x-text="item.cliente"></p>
                                </div>
                            </td>
                            <td class="px-8 py-6">
                                <p class="text-slate-200 font-black text-sm" x-text="item.servicio"></p>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-1 h-1 rounded-full bg-sky-500"></div>
                                    <p class="text-[10px] text-sky-400/80 font-black uppercase tracking-tighter" x-text="item.empleado"></p>
                                </div>
                            </td>
                            <td class="px-8 py-6">
                                <div class="flex flex-col">
                                    <p class="text-white font-bold text-sm" x-text="item.fecha_display"></p>
                                    <p class="text-slate-500 font-black text-[10px] uppercase" x-text="item.hora"></p>
                                </div>
                            </td>
                            <td class="px-8 py-6 text-center">
                    <span :class="{
                        'bg-emerald-500/10 text-emerald-400 border-emerald-500/20': item.estado.toLowerCase() === 'realizada',
                        'bg-indigo-500/10 text-indigo-400 border-indigo-500/20': item.estado.toLowerCase() === 'completada',
                        'bg-rose-500/10 text-rose-400 border-rose-500/20': item.estado.toLowerCase() === 'cancelada',
                        'bg-amber-500/10 text-amber-400 border-amber-500/20': item.estado.toLowerCase() === 'pendiente',
                        'bg-sky-500/10 text-sky-400 border-sky-500/20': item.estado.toLowerCase() === 'confirmada'
                    }" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest border inline-block min-w-[110px]" x-text="item.estado"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
<template x-if="items.length === 0">
    <div class="p-20 flex flex-col items-center justify-center text-center">
        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4 text-slate-700">
            <i :class="filtrosActivos ? 'fa-solid fa-folder-open' : 'fa-solid fa-filter'" class="text-3xl"></i>
        </div>
        
        <template x-if="!filtrosActivos">
            <div>
                <h3 class="text-white font-black uppercase tracking-widest">Buscador de Historial</h3>
                <p class="text-slate-500 text-xs mt-2">Utiliza el botón <span class="text-sky-400 font-bold">"Filtrar Agenda"</span> para consultar registros.</p>
            </div>
        </template>

        <template x-if="filtrosActivos">
            <div>
                <h3 class="text-white font-black uppercase tracking-widest">Sin coincidencias</h3>
                <p class="text-slate-500 text-xs mt-2">No encontramos reservas con los criterios aplicados.</p>
            </div>
        </template>
    </div>
</template>
    </div>
</div>

<script id="reservas-data" type="application/json">
    {{ reservas_json | safe }}
</script>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

{% endblock %}